<!DOCTYPE html>
<html lang="en" dir="ltr">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Creating a link shortener in 12 lines of code using Cloudflare Workers &#43; Bonus | rooyca</title>
<meta name="keywords" content="Cloudflare, URL Shortener" />
<meta name="description" content="Creating a link shortener with this tool (Cloudflare Workers) is very easy, here is a small tutorial on how to do it.">
<meta name="author" content="rooyca">
<link rel="canonical" href="/en/articles/cloudflare_url_shortener/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7bfe087ae72df31787ec7a1360dd05ee246a179b51cf7a30a904b39d7f813b69.css" integrity="sha256-e/4Ieuct8xeH7HoTYN0F7iRqF5tRz3owqQSznX&#43;BO2k=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="mask-icon" href="/images/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="/en/articles/cloudflare_url_shortener/" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="en/" accesskey="h" title="rooyca (Alt + H)">rooyca</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="/es/" title="Spanish"
                            aria-label="Spanish">Spanish</a>
                    </li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="en/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="en/articles/" title="Articles">
                    <span>Articles</span>
                </a>
            </li>
            <li>
                <a href="en/contact/" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="en/">Home</a></div>
    <h1 class="post-title">
      Creating a link shortener in 12 lines of code using Cloudflare Workers &#43; Bonus
    </h1>
    <div class="post-description">
      Creating a link shortener with this tool (Cloudflare Workers) is very easy, here is a small tutorial on how to do it.
    </div>
    <div class="post-meta"><span title='2023-03-19 00:00:00 +0000 UTC'>March 19, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;rooyca</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#cloudflare-workers" aria-label="Cloudflare Workers">Cloudflare Workers</a></li>
                <li>
                    <a href="#kv-storage" aria-label="KV Storage">KV Storage</a></li>
                <li>
                    <a href="#creando-el-servicio-worker" aria-label="Creando el servicio worker">Creando el servicio <em>worker</em></a></li>
                <li>
                    <a href="#asignando-el-kv-namespace-a-una-variable" aria-label="Asignando el KV namespace a una variable">Asignando el KV namespace a una variable</a></li>
                <li>
                    <a href="#el-c%c3%b3digo" aria-label="El código">El código</a></li>
                <li>
                    <a href="#testeando-y-desplegando" aria-label="Testeando y desplegando">Testeando y desplegando</a></li>
                <li>
                    <a href="#bonus---a%c3%b1adiendo-un-subdominio-para-nuestro-worker" aria-label="Bonus - Añadiendo un subdominio para nuestro worker">Bonus - Añadiendo un subdominio para nuestro worker</a></li>
                <li>
                    <a href="#conclusi%c3%b3n" aria-label="Conclusión">Conclusión</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content">
  <p><em>Post original <a href="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/">aquí</a></em></p>
<h2 id="cloudflare-workers">Cloudflare Workers</h2>
<p><a href="https://developers.cloudflare.com/workers/">Cloudflare Workers</a>, de forma muy resumida, es un entorno serverless que corre Javascript. Básicamente, escribes código que se ocupa de peticiones HTTP, similar a Node.js. El código es desplegado globalmente en toda la red de Cloudflare, lo que significa que siempre está corriendo lo más cerca posible del usuario final.</p>
<p>Para este proyecto, al ser algo pequeño, con el plan gratis será más que suficiente. Si te interesa hacer algo más grande te vendría bien revisar los planes de pago.</p>
<h2 id="kv-storage">KV Storage</h2>
<p>Primero, necesitaremos un lugar para almacenar nuestra información. Usaremos <a href="https://developers.cloudflare.com/workers/runtime-apis/kv">Workers KV</a>, el cual no es más que un almacenamiento de llave - valor (key-value, en inglés) proporcionado por Cloudflare Workers. Nos dirigimos a <strong>Workers &gt; KV</strong> damos click en <strong>Create namespace</strong>. Seleccionamos un nombre y damos click en <strong>Add</strong>:</p>
<p><img loading="lazy" src="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/create-kv-namespace.png" alt="Screenshot of the ‘Create namespace’ form in Cloudflare dashboard"  title="Create namespace"  />
</p>
<p>Damos click en <strong>View</strong> en la lista de <em>namespace</em> para acceder a nuestro nuevo <em>namespace</em>,  y añadimos algunas entradas. La llave será el &ldquo;<em>token</em>&rdquo; para nuestro enlace corto, y el valor será la URL a la que se redirecionará.</p>
<p><img loading="lazy" src="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/kv-entries.png" alt="Screenshot of the KV key-value editor UI"  title="KV entries"  />
</p>
<h2 id="creando-el-servicio-worker">Creando el servicio <em>worker</em></h2>
<p>Ahora, nos dirigimos a la parte de <strong>Workers &gt; Overview</strong>, y damos click en <strong>Create a service</strong>. Escogemos un nombre, seleccionamos la platilla de <strong>HTTP handler</strong> con el modulo sintaxis, y finalmente damos click en <strong>Create service</strong>:</p>
<p><img loading="lazy" src="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/create-service.png" alt="Screenshot of the ‘Create a service’ form in Cloudflare dashboard"  title="Create a service"  />
</p>
<p>Debería redireccionarnos a nuestro nuevo servicio:</p>
<p><img loading="lazy" src="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/worker-service-page.png" alt="Screenshot of the worker service page"  title="Service page"  />
</p>
<h2 id="asignando-el-kv-namespace-a-una-variable">Asignando el KV namespace a una variable</h2>
<p>Antes de comenzar a programar, necesitamos asignar nuestro KV namespace a una variable, de tal manera que podamos accederlo desde nuestro código. Vamos a la pestaña de <strong>Settings</strong>, luego a la sección de <strong>Variables</strong>:</p>
<p><img loading="lazy" src="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/settings-variables.png" alt="Screenshot of the Variables page of the service"  title="Settings &gt; Variables"  />
</p>
<p>En <strong>KV Namespace Bindings</strong> damos click en <strong>Add binding</strong>, ingresamos <code>kv</code> como nombre de  variable  (tú puedes seleccionar otro nombre, si gustas), seleccionamos el KV namespace que creamos antes, y damos <strong>Save</strong>.</p>
<p><img loading="lazy" src="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/kv-namespace-binding.png" alt="Screenshot of the “Add KV namespace binding” form"  title="KV namespace binding"  />
</p>
<h2 id="el-código">El código</h2>
<p>Estamos listo para comenzar a programar! Regresamos a la pestaña de <strong>Resources</strong>, y damos click en el botón de <strong>Quick edit</strong>:</p>
<p><img loading="lazy" src="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/code-editor.png" alt="Screenshot of the code editor for the service"  title="Code editor"  />
</p>
<p>En la izquierda encontramos un simple editor de Javascript, y en la derecha una UI para testear nuestro worker. Puedes enviar peticiones al worker y verificar cómo responde. Esto hará que testear nuestro código sea <em>muy</em> sencillo!</p>
<p>Remplazamos el código con el siguiente:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">!=</span> <span class="s2">&#34;GET&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s2">&#34;Forbidden&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">status</span><span class="o">:</span> <span class="mi">403</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">pathname</span> <span class="p">}</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">pathname</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s2">&#34;Not found&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">status</span><span class="o">:</span> <span class="mi">404</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">dest</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">env</span><span class="p">.</span><span class="nx">kv</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">dest</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s2">&#34;Redirecting...&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">status</span><span class="o">:</span> <span class="mi">302</span><span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&#34;Location&#34;</span><span class="o">:</span> <span class="nx">dest</span> <span class="p">}});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s2">&#34;Not found&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">status</span><span class="o">:</span> <span class="mi">404</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Rápida explicación del código:</p>
<ul>
<li>Tenemos dos parámetros:
<ul>
<li><code>request</code>, el cual representa la petición HTTP que acabamos de recibir</li>
<li><code>env</code>, el cual nos da acceso a las variables de entorno y al <em>KV namespace bindings</em></li>
</ul>
</li>
<li>Solo queremos procesar peticiones del tipo <code>GET</code>, por lo que respondemos <code>403 Forbidden</code> si la petición no es tipo <code>GET</code>.</li>
<li>Extraemos la dirección de la URL, y luego tomamos la primera parte de la dirección; este es el token (o llave) para el enlace corto.</li>
<li>Accedemos al KV namespace para encontrar nuestra URL de destino, la cual está asociada con nuestro token.</li>
<li>Si lo encontramos, respondemos con <code>302 Found</code> para redireccionar a nuestra URL (esto lo especificamos en el header <code>Location</code>)</li>
<li>De lo contrario, respondemos con un <code>404 Not Found</code></li>
</ul>
<h2 id="testeando-y-desplegando">Testeando y desplegando</h2>
<p>Puedes hacer un test usando el panel <strong>HTTP</strong>:</p>
<p><img loading="lazy" src="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/test-notfound.png" alt="Screenshot of a request for a non-existing URL token, returning a 404 response"  title="Not found"  />
 <img loading="lazy" src="https://thomaslevesque.com/2022/11/01/building-a-url-shortener-in-12-lines-of-code-using-cloudflare-workers/test-found.png" alt="Screenshot of a request for an existing URL token, returning a 302 response"  title="Found"  />
</p>
<p>Una vez que estamos satisfechos con los resultados y hemos comprobado que todo funciona correctamente podemos desplegar la instancia dando click en el botón de <strong>Save and deploy</strong>.</p>
<p>Cuando lo hemos desplegado, podemos ingresar la dirección del panel de test directamente en nuestro navegador y nos redireccionará a nuestra URL de destino.</p>
<h2 id="bonus---añadiendo-un-subdominio-para-nuestro-worker">Bonus - Añadiendo un subdominio para nuestro worker</h2>
<p>Nos dirigimos a la pestaña de <strong>Triggers</strong>, damos click en el botón <strong>Add Custom Domain</strong>:</p>
<p><img loading="lazy" src="https://res.cloudinary.com/rooyca/image/upload/v1679243345/Blog/Imgs/Cloudflare%20Worker/Pasted_image_20230319111559_i9ceaq.png" alt="Custom domains"  />
</p>
<p>Luego ingresamos nuestro subdominio, del tipo <strong>radio.example.com</strong>:</p>
<p><img loading="lazy" src="https://res.cloudinary.com/rooyca/image/upload/v1679243345/Blog/Imgs/Cloudflare%20Worker/Pasted_image_20230319111912_lmoppf.png" alt="add subdomain"  />
</p>
<p>Y listo, al ingresar a nuestro subdominio con un token valido, nos redireccionará a nuestra URL.</p>
<h2 id="conclusión">Conclusión</h2>
<p>Acabamos de crear un acortador de enlaces en 12 lineas de código (claro, sin contar los espacios en blanco ni los corchetes) Nada mal. Es bastante minimalista, pero es un buen comienzo. Recordemos que siempre podemos añadir más URL desde el <em>KV editor</em>.</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/en/tags/cloudflare/">Cloudflare</a></li>
      <li><a href="/en/tags/url-shortener/">URL Shortener</a></li>
    </ul>

<div class="share-buttons">

    <a target="_blank" rel="noopener noreferrer" aria-label="share Creating a link shortener in 12 lines of code using Cloudflare Workers &#43; Bonus on linkedin"
        href="https://www.linkedin.com/in/heycharlola/">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>© 2023</span>
    <span>||</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
